---
- name: Ensure Redis kernel setting (vm.overcommit_memory=1)
  sysctl:
    name: vm.overcommit_memory
    value: "1"
    state: present
    reload: true

- name: Ensure Redis base directory exists
  file:
    path: "{{ redis_dir }}"
    state: directory
    mode: "0755"

- name: Ensure Sentinel data directory exists
  file:
    path: "{{ redis_sentinel_dir }}"
    state: directory
    mode: "0777"

- name: Copy sentinel.conf
  copy:
    src: sentinel.conf
    dest: "{{ redis_sentinel_dir }}/sentinel.conf"
    mode: "0666"

- name: Copy combined Redis+Sentinel docker-compose.yml for this host
  copy:
    src: "vm{{ '1' if inventory_hostname == 'vm1' else '2' if inventory_hostname == 'vm2' else '3' }}/docker-compose.yml"
    dest: "{{ redis_dir }}/docker-compose.yml"
    mode: "0644"

# Stage 1: Start Redis ONLY (data plane)
- name: Start Redis only (docker compose up -d redis)
  command: docker compose up -d redis
  args:
    chdir: "{{ redis_dir }}"

- name: Check Redis role (master/replica)
  command: docker exec -t redis{{ '1' if inventory_hostname == 'vm1' else '2' if inventory_hostname == 'vm2' else '3' }} redis-cli -p 6379 INFO replication
  register: redis_info
  changed_when: false

- name: Show Redis replication info
  debug:
    var: redis_info.stdout_lines

# Stage 2: Start Sentinel (control plane) LAST
- name: Start Sentinel (docker compose up -d sentinel)
  command: docker compose up -d sentinel
  args:
    chdir: "{{ redis_dir }}"

- name: Check Sentinel master discovery (from each VM)
  command: docker exec -t sentinel{{ '1' if inventory_hostname == 'vm1' else '2' if inventory_hostname == 'vm2' else '3' }} redis-cli -p 26379 SENTINEL get-master-addr-by-name mymaster
  register: sentinel_master
  changed_when: false
  retries: 10
  delay: 2
  until: sentinel_master.rc == 0

- name: Show Sentinel master
  debug:
    var: sentinel_master.stdout_lines
